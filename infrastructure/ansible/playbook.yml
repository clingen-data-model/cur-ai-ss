# Curator VM Ansible Playbook
# 
# Ansible Installation:
#   - `brew install ansible` on Mac.
#
# Usage:
#   ansible-playbook -i <ssh-host>, playbook.yml \
#     -e domain=example.com
#
# Required variables:
#   domain        - Domain name for nginx server_name
#
# Optional variables:
#   gcp_project           - CAA project name (default: clingen-caa)
#   ssl_cert_secret       - Secret Manager name for SSL cert (default: caa-ssl-cert)
#   ssl_key_secret        - Secret Manager name for SSL key (default: caa-ssl-key)
#   openai_api_key_secret - Secret Manager name for OpenAI key (default: caa-openai-api-key)
#   git_repo              - Git repository URL (default: https://github.com/clingen-data-model/cur-ai-ss.git)
#   git_version           - Git ref to deploy (default: main)
#
# Examples:
#   ansible-playbook -i dev-caa, playbook.yml \
#     -e domain=myapp.example.com \
#
#   # Deploy a specific tag
#   ansible-playbook -i dev-caa, playbook.yml \
#     -e domain=myapp.example.com \
#     -e git_version=v1.0.0
#
#   # Dry run (check mode)
#   ansible-playbook -i dev-caa, playbook.yml --check \
#     -e domain=myapp.example.com
#
# Note: The trailing comma after the hostname is required for single-host inventory.
#       The SSH host should be pre-configured in ~/.ssh/config with appropriate
#       User, IdentityFile, and other connection settings.
#
# Prerequisites:
#   -  Secrets stored in Google Secret Manager:
#      # SSL certificate
#      gcloud secrets create caa-ssl-cert --project=PROJECT
#      gcloud secrets versions add caa-ssl-cert --data-file=fullchain.pem --project=PROJECT
#      # SSL private key
#      gcloud secrets create caa-ssl-key --project=PROJECT
#      gcloud secrets versions add caa-ssl-key --data-file=privkey.pem --project=PROJECT
#      # OpenAI API key
#      gcloud secrets create caa-openai-api-key --project=PROJECT
#      echo -n "sk-..." | gcloud secrets versions add caa-openai-api-key --data-file=- --project=PROJECT
#
- name: Configure CAA VM
  hosts: all
  become: yes

  vars:
    gcp_project: clingen-caa
    caa_user: caa
    # Git repository settings
    git_repo: https://github.com/clingen-data-model/cur-ai-ss.git
    git_version: main
    # Secret Manager secret names (can be overridden via -e)
    ssl_cert_secret: caa-ssl-cert
    ssl_key_secret: caa-ssl-key
    openai_api_key_secret: caa-openai-api-key

  tasks:
    # --- Package Installation ---
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install system dependencies
      apt:
        name:
          - nginx
          - acl  # Required for Ansible become_user with unprivileged users
          - git
          # Build dependencies for Python packages
          - build-essential
          - python3.12
          - python3.12-dev
          # OpenCV dependencies (required by docling for table extraction)
          - libgl1
          - libglib2.0-0
        state: present

    # --- User Setup ---

    - name: Create CAA user
      user:
        name: "{{ caa_user }}"
        shell: /bin/bash
        create_home: yes
      register: caa_user_result

    - name: Ensure XDG runtime dir exists
      file:
        path: /run/user/{{ caa_user_result.uid }}
        state: directory
        owner: "{{ caa_user }}"
        group: "{{ caa_user }}"
        mode: "0700"

    - name: Enable lingering for CAA user
      command: loginctl enable-linger {{ caa_user }}
      args:
        creates: /var/lib/systemd/linger/{{ caa_user }}
      failed_when: false # Prevents the task from failing if the command returns a non-zero exit code (e.g., if the user is already configured to linger).
      changed_when: false # Prevents the task from showing as "changed" in Ansible reports, keeping output clean if already enabled.

    - name: Configure user environment (PATH + XDG_RUNTIME_DIR)
      blockinfile:
        path: /home/{{ caa_user }}/.profile
        marker: "# {mark} ANSIBLE MANAGED - user env"
        block: |
          # Ensure user-local binaries are on PATH
          export PATH="$HOME/.local/bin:$PATH"

          # Set XDG_RUNTIME_DIR for systemd user services when needed
          if [ -z "$XDG_RUNTIME_DIR" ]; then
              export XDG_RUNTIME_DIR="/run/user/$(id -u)"
          fi
        owner: "{{ caa_user }}"
        group: "{{ caa_user }}"
        mode: "0644"

    # --- Idempotently Install uv ---
    - name: Install uv (idempotent)
      become_user: "{{ caa_user }}"
      shell: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
      args:
        creates: /home/{{ caa_user }}/.local/bin/uv # If the file exists → task is skipped → idempotent

    # --- Application Directories ---

    - name: Create app directory
      file:
        path: "/opt/{{ caa_user }}"
        state: directory
        owner: "{{ caa_user }}"
        group: "{{ caa_user }}"
        mode: "0755"

    - name: Create data directory
      file:
        path: "/var/{{ caa_user }}"
        state: directory
        owner: "{{ caa_user }}"
        group: "{{ caa_user }}"
        mode: "0755"

    # --- Clone/Update Application Code ---

    - name: Clone or update application repository
      become_user: "{{ caa_user }}"
      git:
        repo: "{{ git_repo }}"
        dest: "/opt/{{ caa_user }}"
        version: "{{ git_version }}"
        force: yes
      register: git_result
      notify: Restart services

    # --- Python Environment ---

    - name: Install Python dependencies
      become_user: "{{ caa_user }}"
      command: /home/{{ caa_user }}/.local/bin/uv sync --frozen --no-dev --system
      args:
        chdir: "/opt/{{ caa_user }}"
      register: uv_sync_result
      changed_when: uv_sync_result.rc == 0
      notify: Restart services

    # --- Environment File ---

    - name: Fetch OpenAI API key from Secret Manager
      delegate_to: localhost
      become: no
      command: >
        gcloud secrets versions access latest
        --secret={{ openai_api_key_secret }}
        --project={{ gcp_project }}
      register: openai_api_key_content
      changed_when: false
      no_log: true

    - name: Deploy environment file
      template:
        src: templates/env.j2
        dest: "/opt/{{ caa_user }}/.env"
        owner: "{{ caa_user }}"
        group: "{{ caa_user }}"
        mode: "0600"
      notify: Restart services

    # --- Systemd User Services ---

    - name: Create systemd user config directory
      file:
        path: /home/{{ caa_user }}/.config/systemd/user
        state: directory
        owner: "{{ caa_user }}"
        group: "{{ caa_user }}"
        mode: "0755"

    - name: Deploy api systemd service
      template:
        src: templates/api.service.j2
        dest: /home/{{ caa_user }}/.config/systemd/user/api.service
        owner: "{{ caa_user }}"
        group: "{{ caa_user }}"
        mode: "0644"
      notify: Restart services

    - name: Deploy ui systemd service
      template:
        src: templates/ui.service.j2
        dest: /home/{{ caa_user }}/.config/systemd/user/ui.service
        owner: "{{ caa_user }}"
        group: "{{ caa_user }}"
        mode: "0644"
      notify: Restart services

    - name: Deploy worker systemd service
      template:
        src: templates/worker.service.j2
        dest: /home/{{ caa_user }}/.config/systemd/user/worker.service
        owner: "{{ caa_user }}"
        group: "{{ caa_user }}"
        mode: "0644"
      notify: Restart services

    - name: Reload systemd user daemon
      become_user: "{{ caa_user }}"
      environment:
        XDG_RUNTIME_DIR: /run/user/{{ caa_user_result.uid }}
      systemd:
        daemon_reload: yes
        scope: user

    - name: Enable and start CAA services
      become_user: "{{ caa_user }}"
      environment:
        XDG_RUNTIME_DIR: /run/user/{{ caa_user_result.uid }}
      systemd:
        name: "{{ item }}"
        enabled: yes
        state: started
        scope: user
      loop:
        - api
        - ui
        - worker

    # --- SSL Certificate Setup ---

    - name: Create nginx SSL directory
      file:
        path: /etc/nginx/ssl
        state: directory
        owner: root
        group: root
        mode: "0700"

    - name: Fetch SSL certificate from Secret Manager
      delegate_to: localhost
      become: no
      command: >
        gcloud secrets versions access latest
        --secret={{ ssl_cert_secret }}
        --project={{ gcp_project }}
      register: ssl_cert_content
      changed_when: false
      no_log: true

    - name: Fetch SSL private key from Secret Manager
      delegate_to: localhost
      become: no
      command: >
        gcloud secrets versions access latest
        --secret={{ ssl_key_secret }}
        --project={{ gcp_project }}
      register: ssl_key_content
      changed_when: false
      no_log: true

    - name: Deploy SSL certificate
      copy:
        content: "{{ ssl_cert_content.stdout }}"
        dest: /etc/nginx/ssl/fullchain.pem
        owner: root
        group: root
        mode: "0644"
      notify: Reload nginx
      no_log: true

    - name: Deploy SSL private key
      copy:
        content: "{{ ssl_key_content.stdout }}"
        dest: /etc/nginx/ssl/privkey.pem
        owner: root
        group: root
        mode: "0600"
      notify: Reload nginx
      no_log: true

    # --- Nginx Configuration ---

    - name: Deploy nginx site configuration
      template:
        src: templates/nginx.conf.j2
        dest: /etc/nginx/sites-available/caa
        owner: root
        group: root
        mode: "0644"
      notify: Reload nginx

    - name: Enable nginx site
      file:
        src: /etc/nginx/sites-available/caa
        dest: /etc/nginx/sites-enabled/caa
        state: link
      notify: Reload nginx

    - name: Remove default nginx site
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: Reload nginx

    - name: Validate nginx configuration
      command: nginx -t
      changed_when: false

    - name: Enable and start nginx
      systemd:
        name: nginx
        enabled: yes
        state: started

  # --- Handlers ---

  handlers:
    - name: Restart services
      become_user: "{{ caa_user }}"
      environment:
        XDG_RUNTIME_DIR: /run/user/{{ caa_user_result.uid }}
      systemd:
        name: "{{ item }}"
        state: restarted
        scope: user
      loop:
        - api
        - ui
        - worker

    - name: Reload nginx
      systemd:
        name: nginx
        state: reloaded
