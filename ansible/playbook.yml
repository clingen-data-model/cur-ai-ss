# Curator VM Ansible Playbook
#
# Usage:
#   ansible-playbook -i <ssh-host>, playbook.yml \
#     -e curator_domain=example.com \
#     -e gcp_project=my-project \
#     -e openai_api_deployment=gpt-4
#
# Required variables:
#   curator_domain        - Domain name for nginx server_name
#   gcp_project           - GCP project containing secrets
#   openai_api_deployment - OpenAI deployment/model name
#
# Optional variables:
#   ssl_cert_secret       - Secret Manager name for SSL cert (default: gene-curation-ai-ssl-cert)
#   ssl_key_secret        - Secret Manager name for SSL key (default: gene-curation-ai-ssl-key)
#   openai_api_key_secret - Secret Manager name for OpenAI key (default: cur-ai-ss-openai-api-key)
#   cors_allowed_origins  - CORS origins (default: https://{{ curator_domain }})
#
# Examples:
#   ansible-playbook -i curator-vm, playbook.yml \
#     -e curator_domain=myapp.example.com \
#     -e gcp_project=my-gcp-project \
#     -e openai_api_deployment=gpt-4
#
#   # Dry run (check mode)
#   ansible-playbook -i curator-vm, playbook.yml --check \
#     -e curator_domain=myapp.example.com \
#     -e gcp_project=my-gcp-project \
#     -e openai_api_deployment=gpt-4
#
# Note: The trailing comma after the hostname is required for single-host inventory.
#       The SSH host should be pre-configured in ~/.ssh/config with appropriate
#       User, IdentityFile, and other connection settings.
#
# Prerequisites:
#   1. Secrets stored in Google Secret Manager:
#      # SSL certificate
#      gcloud secrets create gene-curation-ai-ssl-cert --project=PROJECT
#      gcloud secrets versions add gene-curation-ai-ssl-cert --data-file=fullchain.pem --project=PROJECT
#      # SSL private key
#      gcloud secrets create gene-curation-ai-ssl-key --project=PROJECT
#      gcloud secrets versions add gene-curation-ai-ssl-key --data-file=privkey.pem --project=PROJECT
#      # OpenAI API key
#      gcloud secrets create cur-ai-ss-openai-api-key --project=PROJECT
#      echo -n "sk-..." | gcloud secrets versions add cur-ai-ss-openai-api-key --data-file=- --project=PROJECT
#
#   2. gcloud CLI installed on the control machine (where ansible runs)

- name: Configure curator VM
  hosts: all
  become: yes

  vars:
    curator_user: cur-ai-ss
    app_dir: /opt/cur-ai-ss
    data_dir: /var/cur-ai-ss
    compose_src: ../deployment/docker-compose.yaml
    # Secret Manager secret names (can be overridden via -e)
    ssl_cert_secret: gene-curation-ai-ssl-cert
    ssl_key_secret: gene-curation-ai-ssl-key
    openai_api_key_secret: cur-ai-ss-openai-api-key
    # nginx vars
    nginx_ssl_dir: /etc/nginx/ssl

  tasks:
    # --- Package Installation ---

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install podman, nginx, and dependencies
      apt:
        name:
          - podman
          - podman-compose
          - acl  # Required for Ansible become_user with unprivileged users
          - nginx
        state: present

    # --- User Setup ---

    - name: Create curator user
      user:
        name: "{{ curator_user }}"
        shell: /bin/bash
        create_home: yes
      register: curator_user_result

    - name: Enable lingering for curator user
      command: loginctl enable-linger {{ curator_user }}
      args:
        creates: /var/lib/systemd/linger/{{ curator_user }}

    # --- Application Files ---

    - name: Create app directory
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: "{{ curator_user }}"
        group: "{{ curator_user }}"
        mode: "0755"

    - name: Create data directory
      file:
        path: "{{ data_dir }}"
        state: directory
        owner: "{{ curator_user }}"
        group: "{{ curator_user }}"
        mode: "0755"

    - name: Fetch OpenAI API key from Secret Manager
      delegate_to: localhost
      become: no
      command: >
        gcloud secrets versions access latest
        --secret={{ openai_api_key_secret }}
        --project={{ gcp_project }}
      register: openai_api_key_content
      changed_when: false
      no_log: true

    - name: Deploy environment file
      template:
        src: templates/curator.env.j2
        dest: "{{ app_dir }}/.env"
        owner: "{{ curator_user }}"
        group: "{{ curator_user }}"
        mode: "0600"
      notify: Restart curator-compose

    - name: Copy docker-compose.yaml
      copy:
        src: "{{ compose_src }}"
        dest: "{{ app_dir }}/docker-compose.yaml"
        owner: "{{ curator_user }}"
        group: "{{ curator_user }}"
        mode: "0644"
      notify: Restart curator-compose

    # --- Systemd User Service ---

    - name: Create systemd user config directory
      file:
        path: /home/{{ curator_user }}/.config/systemd/user
        state: directory
        owner: "{{ curator_user }}"
        group: "{{ curator_user }}"
        mode: "0755"

    - name: Deploy curator-compose systemd service
      template:
        src: templates/curator-compose.service.j2
        dest: /home/{{ curator_user }}/.config/systemd/user/curator-compose.service
        owner: "{{ curator_user }}"
        group: "{{ curator_user }}"
        mode: "0644"
      notify: Restart curator-compose

    - name: Reload systemd user daemon
      become_user: "{{ curator_user }}"
      environment:
        XDG_RUNTIME_DIR: /run/user/{{ curator_user_result.uid }}
      systemd:
        daemon_reload: yes
        scope: user

    - name: Enable and start curator-compose service
      become_user: "{{ curator_user }}"
      environment:
        XDG_RUNTIME_DIR: /run/user/{{ curator_user_result.uid }}
      systemd:
        name: curator-compose
        enabled: yes
        state: started
        scope: user

    # --- SSL Certificate Setup ---

    - name: Create nginx SSL directory
      file:
        path: "{{ nginx_ssl_dir }}"
        state: directory
        owner: root
        group: root
        mode: "0700"

    - name: Fetch SSL certificate from Secret Manager
      delegate_to: localhost
      become: no
      command: >
        gcloud secrets versions access latest
        --secret={{ ssl_cert_secret }}
        --project={{ gcp_project }}
      register: ssl_cert_content
      changed_when: false
      no_log: true

    - name: Fetch SSL private key from Secret Manager
      delegate_to: localhost
      become: no
      command: >
        gcloud secrets versions access latest
        --secret={{ ssl_key_secret }}
        --project={{ gcp_project }}
      register: ssl_key_content
      changed_when: false
      no_log: true

    - name: Deploy SSL certificate
      copy:
        content: "{{ ssl_cert_content.stdout }}"
        dest: "{{ nginx_ssl_dir }}/fullchain.pem"
        owner: root
        group: root
        mode: "0644"
      notify: Reload nginx
      no_log: true

    - name: Deploy SSL private key
      copy:
        content: "{{ ssl_key_content.stdout }}"
        dest: "{{ nginx_ssl_dir }}/privkey.pem"
        owner: root
        group: root
        mode: "0600"
      notify: Reload nginx
      no_log: true

    # --- Nginx Configuration ---

    - name: Deploy nginx site configuration
      template:
        src: templates/nginx-curator.conf.j2
        dest: /etc/nginx/sites-available/curator
        owner: root
        group: root
        mode: "0644"
      notify: Reload nginx

    - name: Enable nginx site
      file:
        src: /etc/nginx/sites-available/curator
        dest: /etc/nginx/sites-enabled/curator
        state: link
      notify: Reload nginx

    - name: Remove default nginx site
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: Reload nginx

    - name: Validate nginx configuration
      command: nginx -t
      changed_when: false

    - name: Enable and start nginx
      systemd:
        name: nginx
        enabled: yes
        state: started

  # --- Handlers ---

  handlers:
    - name: Restart curator-compose
      become_user: "{{ curator_user }}"
      environment:
        XDG_RUNTIME_DIR: /run/user/{{ curator_user_result.uid }}
      systemd:
        name: curator-compose
        state: restarted
        scope: user

    - name: Reload nginx
      systemd:
        name: nginx
        state: reloaded
